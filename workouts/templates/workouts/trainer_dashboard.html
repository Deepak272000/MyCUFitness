{% extends "base.html" %}
{% load static %}
{% block title %}Trainer Dashboard - MyCUFitness{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Trainer Dashboard</h2>
    <p>Manage your clients and assign workouts based on their fitness goals.</p>

    <!-- Assigned Clients Section -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">Assigned Clients</div>
        <div class="card-body">
            <ul id="client-list"><li>Loading...</li></ul>
        </div>
    </div>

    <!-- Assign Workouts -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">Assign Workouts</div>
        <div class="card-body">
            <form id="assignWorkoutForm">
                <label for="clientSelect" class="form-label">Select Client</label>
                <select id="clientSelect" class="form-select">
                    <option value="">Select Client</option>
                </select>

                <label for="workoutSelect" class="form-label mt-2">Select Workout</label>
                <select id="workoutSelect" class="form-select">
                    <option value="">Select Workout</option>
                </select>

                <button type="submit" class="btn btn-warning mt-3">Assign Workout</button>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript to Fetch Clients & Assign Workouts -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const clientSelect = document.getElementById("clientSelect");
    const workoutSelect = document.getElementById("workoutSelect");
    const clientList = document.getElementById("client-list");

    // Fetch Assigned Clients
    fetch("/workouts/assign-clients/", { headers: { "X-Requested-With": "XMLHttpRequest" } })
    .then(response => response.json())
    .then(data => {
        clientList.innerHTML = "";
        clientSelect.innerHTML = "<option value=''>Select Client</option>";

        if (data.assigned_clients.length === 0) {
            clientList.innerHTML = "<li>No clients assigned yet.</li>";
        } else {
            data.assigned_clients.forEach(client => {
                const li = document.createElement("li");
                li.innerText = `${client.first_name} - ${client.email} (${client.fitness_goals || "No Goal Set"})`;
                clientList.appendChild(li);

                const option = document.createElement("option");
                option.value = client.id;
                option.innerText = `${client.first_name} (${client.fitness_goals || "No Goal"})`;
                clientSelect.appendChild(option);
            });
        }
    }).catch(error => console.error("Error fetching clients:", error));

    // Fetch Workouts
    fetch("/api/workouts/")
    .then(response => response.json())
    .then(data => {
        workoutSelect.innerHTML = "<option value=''>Select Workout</option>";
        data.workouts.forEach(workout => {
            const option = document.createElement("option");
            option.value = workout.id;
            option.innerText = workout.title;
            workoutSelect.appendChild(option);
        });
    }).catch(error => console.error("Error fetching workouts:", error));

    // Assign Workout Form Submission
    document.getElementById("assignWorkoutForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const clientId = clientSelect.value;
        const workoutId = workoutSelect.value;

        if (!clientId || !workoutId) {
            alert("Please select both a client and a workout.");
            return;
        }

        fetch(`/workouts/assign_workout/${clientId}/`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
            body: JSON.stringify({ workout_id: workoutId })
        })
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => console.error("Error:", error));
    });

    // Function to get CSRF token for Django POST requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(cookie => {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                }
            });
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
